#!/usr/bin/env zsh

# set -x

gobase() { cd ~/g/base || exit 1; }

cd ~

if [ ! -e .tmux.conf ]; then
    ln -s g/base/{utils,.abcde.conf,.gitconfig,.profile,.urlview} ~
    ln -s g/base/{.vimrc,.Xdefaults,.vim,.nvim,.tmux.conf,.tigrc} ~
    [[ -d ~/.config ]] || mkdir ~/.config
    ln -s ~/g/base/.config/* ~/.config
    ( cd ~ && ln -s g/base/.zshrc* . )

    curl -sL --proto-redir -all,https \
        https://raw.githubusercontent.com/zplug/installer/master/installer.zsh \
        | zsh

    curl -fLo ~/.vim/autoload/plug.vim --create-dirs \
        https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
fi

source ~/.zplug/init.zsh
zplug clear
zplug update

gobase

curl -SL https://github.com/docker/cli/raw/master/contrib/completion/zsh/_docker \
    >| ~/g/base/zsh/functions/_docker
curl -SL https://raw.githubusercontent.com/docker/compose/master/contrib/completion/zsh/_docker-compose \
    >| ~/g/base/zsh/functions/_docker-compose
curl -SL https://raw.githubusercontent.com/docker/machine/master/contrib/completion/zsh/_docker-machine \
    >| ~/g/base/zsh/functions/_docker-machine
curl -SL https://raw.githubusercontent.com/perlpunk/shell-completions/master/zsh/_dzil \
    >| ~/g/base/zsh/functions/_dzil
if [[ "$(uname)" == Darwin ]]; then
    curl https://raw.githubusercontent.com/zsh-users/zsh/master/Completion/Unix/Command/_git \
        >| ~/g/base/zsh/functions/_git
fi
rm -f ~/.zcompdump; autoload -Uz compinit && compinit -i

if [ -d ~/.tmux/plugins/tpm ]; then
    ~/.tmux/plugins/tpm/bindings/clean_plugins
    ~/.tmux/plugins/tpm/bindings/install_plugins
    ~/.tmux/plugins/tpm/scripts/update_plugin_prompt_handler.sh all
fi

if [[ "$(uname)" == Darwin ]]; then
    if [ ! which brew >&/dev/null ]; then
        /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
    else
        brew update
        brew upgrade
        brew bundle dump
    fi

    fzfcomp=/usr/local/opt/fzf/shell/completion.zsh
    if ! grep -q "emulate -L zsh" $fzfcomp; then
        perl -pi -e 's/fzf-completion\(\) \{\K/\n  emulate -L zsh/' \
            $fzfcomp
    fi

    pip3=pip
elif [[ "$(uname)" == FreeBSD ]]; then
    sudo pkg install          \
        bat                   \
        diff-so-fancy         \
        fd-find               \
        fzf                   \
        highlight             \
        multitail             \
        neovim                \
        pigz                  \
        pixz                  \
        py36-pip              \
        py36-powerline-status \
        py36-ranger           \
        ripgrep               \
        thefuck               \
        tig                   \
        universal-ctags       \
        wget                  \
        zsh

    sudo pkg upgrade
    pip3=pip-3.6
else
    pip3=pip3
    sudo aptitude -y install golang python-pip

    $pip3 install --upgrade pip

    # sudo gem install colorls
    # sudo gem update colorls

    # urlwatch
    $pip3 install --upgrade --user pyyaml minidb requests keyring chump urlwatch

    $pip3 install --upgrade --user thefuck
fi

if [[ "$EDITOR" == "nvim" ]]; then
    $pip3 install --upgrade --user neovim
    $pip3 install --upgrade --user vim-vint proselint
    $pip3 install --upgrade --user git+git://github.com/powerline/powerline

    # denite
    $pip3 install --upgrade --user typing

    $EDITOR -c PlugUpgrade -c qa
    # $EDITOR -c PlugClean   -c qa
    $EDITOR -c PlugInstall -c qa
    $EDITOR -c PlugUpdate  -c qa

    $EDITOR -c UnicodeDownload -c qa

    $EDITOR -c "CocInstall coc-dictionary coc-tag coc-emoji" -c qa
fi

if [[ $(uname) == Linux ]]; then
    gobase
    command go get -u github.com/motemen/ghq
    build_all
fi
