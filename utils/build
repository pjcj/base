#!/bin/sh

set -e

dir=$1
test -z "$dir" && dir=$(basename "$(pwd)")

sw=$HOME/g/sw

configure() {
    [ -f ./configure ] || ./autogen.sh
    ./configure --prefix="$sw" "$@"
}

exit_unless_x() {
    if ! xset q > /dev/null 2>&1; then
        echo "not running under X, ignoring $dir"
        exit
    fi
}

case "$dir" in
    urlview)
        autoreconf -vfi
        configure
        make check install
        ;;
    htop)
        sudo aptitude -y install libncursesw5-dev
        configure
        make check install
        ;;
    libevent)
        exit_unless_x
        configure
        make install
        ;;
    neovim)
        sudo aptitude -y install libtool-bin
        git clean -dxf
        make CMAKE_EXTRA_FLAGS="-DCMAKE_INSTALL_PREFIX:PATH=$sw" \
             CMAKE_BUILD_TYPE=Release test install
        ;;
    st)
        exit_unless_x
        sudo aptitude -y install fontconfig libfontconfig1-dev \
            libfreetype6 libfreetype6-dev libxft-dev
        make clean install
        ;;
    sxhkd|bspwm)
        exit_unless_x
        sudo aptitude -y install libxcb-util0-dev libxcb-keysyms1-dev     \
            libxcb-xinerama0-dev libxcb-randr0-dev libxcb-icccm4-dev      \
            libxcb-ewmh1-dev xcb libxcb-util0-dev libxcb-ewmh-dev         \
            libxcb-randr0-dev libxcb-icccm4-dev libxcb-keysyms1-dev       \
            libxcb-xinerama0-dev libxcb-ewmh2                             \
            gnome-panel
        make PREFIX="$sw" all install
        ;;
    xdotool)
        exit_unless_x
        sudo aptitude -y install libxinerama-dev x11proto-xinerama-dev \
            libxkbcommon-dev
        make PREFIX="$sw" all test install
        sudo ldconfig
        ;;
    zsh)
        autoreconf -vfi
        configure --enable-pcre
        make
        make check
        make install || echo make install expected to fail
        ;;
    tmux)
        export LIBEVENT_CFLAGS="-I$sw/include"
        export LIBEVENT_LIBS="-L$sw/lib -Wl,-rpath=$sw/lib -levent"
        configure
        make check install
        ;;
    zsh-git-prompt)
        stack setup
        stack build && stack install
        ;;
    shellcheck)
        cabal update && cabal install --prefix="$sw"
        ;;
    skype)
        exit_unless_x
        sudo dpkg --add-architecture i386
        sudo add-apt-repository "deb http://archive.canonical.com/ $(lsb_release -sc) partner"
        sudo aptitude update && sudo aptitude -y install skype
        ;;
    ClipIt)
        exit_unless_x
        sudo aptitude -y install autopoint intltool
        ./autogen.sh
        configure
        make
        make install
        ;;
    PathPicker)
        set -x
        target="$sw/bin/fpp"
        [ -e "$target" ] || ln -s "$(pwd)/fpp" "$target"
        ;;
    *)
        echo unknown directory "$dir"
        ;;
esac

echo "built $dir"
