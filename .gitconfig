[user]
  name                          = Paul Johnson
  email                         = paul@pjcj.net
[core]
  pager                         = delta
  whitespace                    = trailing-space,space-before-tab
  autocrlf                      = input
  excludesfile                  = ~/.gitignore_global
[transfer]
  fsckObjects                   = true
[gc]
  pruneExpire                   = 60 days
[init]
  defaultBranch                 = main
[column]
  ui                            = auto
[help]
  autocorrect                   = prompt
[branch]
  sort                          = -committerdate
[tag]
  sort                          = version:refname
[diff]
  renamelimit                   = 10000
  renames                       = copies
  mnemonicprefix                = true
  algorithm                     = histogram
  colorMoved                    = default
[commit]
  verbose                       = true
[fetch]
  writeCommitGraph              = true
  prune                         = true
  pruneTags                     = true
  all                           = true
  showForcedUpdates             = true
[rebase]
  rebaseMerges                  = true
  updateRefs                    = false
  instructionFormat             = %an (%ai)  %s
[merge]
  ff                            = only
  stat                          = true
  tool                          = nvimdiff
  conflictstyle                 = zdiff3
[merge "keep_ours"]
  name                          = always keep our version during merge
  driver                        = true
[mergetool "nvimdiff"]
  layout                        = "LOCAL,BASE,REMOTE / MERGED + BASE,LOCAL + BASE,REMOTE + (LOCAL/BASE/REMOTE),MERGED"
[pull]
  ff                            = only
[push]
  default                       = current
  followTags                    = true
  autoSetupRemote               = true
  useForceIfIncludes            = true
[interactive]
  diffFilter                    = delta --color-only
[status]
  showUntrackedFiles            = all
[rerere]
  enabled                       = true
  autoupdate                    = true
[blame]
  markUnblamableLines           = true
  markIgnoredLines              = true
[grep]
  patternType                   = perl
[github]
  user                          = pjcj
[url "https://github.com/"]
  insteadOf                     = github:
[color]
[color.grep]
  context                       = blue
  filename                      = "#3f86dc"
  function                      = yellow
  linenumber                    = "#833652"
  match                         = "#f0c53f"
  separator                     = magenta
[color "diff"]
  meta                          = yellow
  commit                        = green
  frag                          = magenta
  old                           = "#dc322f"
  new                           = "#25ad2e"
  whitespace                    = blue reverse
  newMoved                      = "#f0c53f"
[color "diff-highlight"]
  oldNormal                     = "#dc322f"
  newNormal                     = "#25ad2e"
  oldHighlight                  = "#ff8784 #400200"
  newHighlight                  = "#4dbf77 #003203"
[delta]
  commit-style                  = "#25ad2e"
  file-decoration-style         = "#fff179" box
  file-style                    = "#de860e"
  file-added-label              = [+]
  file-copied-label             = [*]
  file-modified-label           = [~]
  file-removed-label            = [⛌]
  file-renamed-label            = [→]
  hunk-header-decoration-style  = "#9599dc" box
  hunk-header-style             = file line-number syntax italic
  line-numbers-left-format      = {nm:^5}
  line-numbers-left-style       = "#9599dc"
  line-numbers-minus-style      = "#dc322f"
  line-numbers-plus-style       = "#25ad2e"
  line-numbers-right-format     = │{np:^5}
  line-numbers-right-style      = "#9599dc"
  line-numbers                  = true
  line-numbers-zero-style       = "#fff179"
  minus-emph-style              = "#ffacaa" "#400200"
  minus-empty-line-marker-style = normal
  minus-non-emph-style          = "#dc322f"
  minus-style                   = "#dc322f"
  plus-emph-style               = "#c9f5cc" "#003203"
  plus-empty-line-marker-style  = normal
  plus-non-emph-style           = "#25ad2e"
  plus-style                    = "#25ad2e"
  syntax-theme                  = Solarized (dark)
  tabs                          = 2
  whitespace-error-style        = reverse blue
  zero-style                    = normal
  blame-code-style              = syntax
  blame-format                  = "{author:<18} {commit:<6} {timestamp:<15}"
  blame-palette                 = "#2E3440" "#3B4252" "#434C5E"
  side-by-side                  = true
  relative-paths                = true
[alias]
  git = !exec git
  g   = !exec git

  bc  = branch --show-current
  bfd = branch-full-delete
  bl  = blame -wMCCC
  br  = branch
  ci  = commit
  co  = checkout
  st  = status -sb
  tfd = tag-full-delete

  alias = "!git config --get-regexp 'alias.*' \
    | colrm 1 6 \
    | sed 's/[ ]/ = /; s/  */ /g' | sort"
  distclean = "!f() { \
    git status --porcelain | grep '??' \
    | awk '{print $2}' | xargs rm; }; f"
  whatis = show -s --pretty='tformat:%h (%s, %ad)' --date=short

  vgc    = repack -fad --depth=250 --window=250
  nvgc   = !ionice -n7 nice -n20 git vgc
  fullgc = "!f() { nice git gc && nice git vgc; }; f"

  latest = for-each-ref --sort=-committerdate \
    --format='%(committerdate:short) %(refname:short)  %(authorname)'

  bmv  = branch -f
  bmvp = "!f() { \
    git bmv $1 $2 \
    && git push origin --force-with-lease $1; }; f"
  omv  = origin-branch-move
  omvo = "!f() { \
    git origin-branch-move $1 && git checkout -q $1; }; f"

  # Pick our version of a file during conflict resolution
  # During merge: keeps our branch's version
  # During rebase: keeps the target branch's version (not yours)
  ours = "!f() { git co --ours $@ && git add $@; }; f"
  # Pick their version of a file during conflict resolution
  # During merge: keeps their branch's version
  # During rebase: keeps your version (the commits being replayed)
  theirs = "!f() { git co --theirs $@ && git add $@; }; f"

  lgm = "!f() { \
    git reflog --format='%H' | xargs git ll; }; f"
  lgr = "!f() { \
    git fsck --no-reflog \
    | awk '/dangling commit/ {print $3}' \
    | xargs git ll; }; f"
  lgd = "!f() { \
    git reflog --since='24 hours ago' --format='%H' \
    | xargs git ll; }; f"

  ll = "!f() { \
    local f=\"%C(#833652)%h%Creset\"; \
    f=\"$f -%C(#f0c53f)%d%C(#9599dc) %s\"; \
    f=\"$f %C(#3f86dc)(%ad) %C(#687e85)%an%Creset\"; \
    git log --graph --topo-order \
    --pretty=format:\"$f\" --date=relative \"$@\"; \
  }; f"
  lg = "!f() { \
    local f=\"%Cred%h%Creset\"; \
    f=\"$f -%C(yellow)%d%Creset %s %Cgreen(%ad)\"; \
    f=\"$f %C(blue)<%an>%Creset\"; \
    git log --graph \
    --pretty=format:\"$f\" --date=relative \"$@\"; \
  }; f"
  lla = ll --all
  lga = lg --all

  # git nd [[[[year] month] day] hour]
  nd = "!f() { git commit --amend --no-edit --no-verify \
    --date=$(git --no-pager show --format='%ai' | head -1 \
    | perl -e ' \
    @n = reverse qq(@ARGV) =~ /(\\d+)/g; \
    @d = <STDIN> =~ /(\\d+)/g; \
    printf q(%04d-%02d-%02dT%02d:%02d:%02d), \
    $n[3] // $d[0], $n[2] // $d[1], \
    $n[1] // $d[2], $n[0] // $d[3], \
    rand 60, rand 60' $@); }; f"

  churn = "!git log --all -M -C --name-only \
    --format='format:' \"$@\" | sort \
    | grep -v '^$' | uniq -c | sort \
    | awk 'BEGIN {print \"count,file\"} \
    {print $1 \", \" $2}' | sort -rn | less"

  # git change-commits <field> "old" "new" [--refs <ref>...]
  # field: committer_name, author_name,
  #        committer_email, author_email
  change-commits = "!f() { \
    F=$1; OLD=$2; NEW=$3; shift 3; \
    echo -n \"Replace $F '$OLD' => '$NEW'? (Y/N) \"; \
    read OK; \
    if [ \"$OK\" = 'Y' ]; then \
      git filter-repo --force --commit-callback \
        \"if commit.$F == b'$OLD': \
        commit.$F = b'$NEW'\" \"$@\"; \
    fi; }; f"

  # git set-ticket [TICKET] [BASE]
  # Add or replace Ticket line on line 3 of each commit
  # on the current branch.
  # TICKET: extracted from branch name if omitted
  # BASE: defaults to main
  set-ticket = "!f() { \
    T=${1:-$(perl -e ' \
      my $re = qr/([A-Z]{2,8}-\\d+)/; \
      my ($br) = `git branch --show-current` =~ /^$re/; \
      $br //= $1 if !$br && `git status` =~ $re; \
      print $br if $br')}; \
    B=${2:-main}; \
    if [ -z \"$T\" ]; then \
      echo 'Cannot determine ticket from branch name'; \
      return 1; \
    fi; \
    echo \"Setting 'Ticket $T' in commits since $B\"; \
    git rebase $B --exec ' \
      git log -1 --format=%B \
      | perl -0777 -pe \"BEGIN { \\$t = q('\"$T\"') } \
        s/\\A([^\\n]+)\\n+Ticket [A-Z]{2,8}-(?:\\d+|XXXXX)\\n?/\\$1\\n/s; \
        s/\\A([^\\n]+)\\n*/\\$1\\n\\nTicket \\$t\\n\\n/; \
        s/\\n{3,}/\\n\\n/g; \
        s/\\s+\\z/\\n/\" \
      | git commit --amend --no-verify -F -'; }; f"

  recent-files = "!f() { \
    git log --all --name-only \
    --pretty=format:%ai%x09%H -- \"${1:-.}\" \
    | perl -ne ' \
    if (/^(\\d{4}-\\d{2}-\\d{2}\\s\\d{2}:\\d{2}:\\d{2})/) \
    { $date = $1 } \
    elsif (/\\S/) \
    { $seen{$_} = $date unless $seen{$_} gt $date } \
    END { \
    foreach (sort { $seen{$b} cmp $seen{$a} } \
    keys %seen) \
    { printf \"%s %s\", $seen{$_}, $_ } }' \
    | fzf \
    --preview='f=$(echo {} \
    | perl -pe \"s/^\\S+\\s+\\S+\\s+//\"); \
    bat --tabs=2 --color=always \"$f\" 2>/dev/null \
    || cat \"$f\" 2>/dev/null' \
    --preview-window=right:70% --with-nth=3.. \
    | perl -pe 's/^\\S+\\s+\\S+\\s+//'; }; f"

[include]
  path = ~/.gitconfig.local
