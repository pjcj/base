---
name: commit
description: >-
  Git commit workflow and message guidelines. Use when committing changes,
  writing commit messages, or reviewing commit practices. Ensures proper
  approval workflow and well-structured commit messages.
user-invocable: true
---

# Git Commit Skill

This skill provides guidance on creating git commits with proper workflow and
well-structured commit messages.

## Critical Rule: User Approval Required

**NEVER make a commit without explicit user approval.**

This applies to ALL commits, no exceptions. Before any commit:

1. Show what will be committed (files)
2. Present the **complete** proposed commit message
3. Ask "Should I commit with this message?"
4. **STOP and wait** - do not proceed until user explicitly approves
5. Only then stage and commit

**The approval step is a hard stop.** After asking, do nothing until the user
responds. Do not stage files. Do not run git commit. Just wait.

**Why this matters:**

- User maintains full control over git history
- Prevents premature or incorrect commits
- Allows user to review the exact message before committing

## Commit Workflow

### Step 0: Verify Changes Work

Before committing, ensure:

- Tests pass
- Linting passes
- LSP reports no problems

Only proceed to commit once changes are verified.

### Step 1: Gather Information

Run these commands in parallel to understand the current state:

```bash
# See all untracked and modified files (never use -uall flag)
git status

# See staged and unstaged changes
git diff
git diff --cached

# See recent commit messages for style reference
git log --oneline -10
```

### Step 2: Stage Changes

Stage the relevant files:

```bash
# Stage specific files
git add path/to/file1 path/to/file2

# Or stage all changes (use with caution)
git add -A
```

**Never commit files that likely contain secrets** (.env, credentials.json,
etc.). Warn the user if they specifically request to commit those files.

### Step 3: Analyse Changes

Review what will be committed:

- What changed and why
- The nature of the changes (new feature, enhancement, bug fix, refactoring)
- Any implications or side effects

### Step 4: Draft Commit Message

Compose a commit message following the format below, then present it to the
user for approval.

### Step 5: Present Commit for Approval

**This is a two-part process. Do NOT combine into one step.**

**Part A - Show what will be committed:**

```bash
git status --short
```

**Part B - Present the COMPLETE proposed commit message:**

Show the exact message that will be used, formatted as it will appear:

```text
Subject line here

Ticket GH-XXXXX

- First point
- Second point
```

**Part C - Ask for approval and STOP:**

Ask: "Should I commit with this message?"

Then **STOP and wait**. Do not proceed until the user explicitly approves.
Do not stage files. Do not run git commit. Just wait.

### Step 6: Create Commit

Only after receiving explicit approval (e.g., "yes", "go ahead", "commit it"):

```bash
git commit -m "$(cat <<'EOF'
Subject line here

Ticket GH-XXXXX

- Description of the change.
- Additional details if needed.
EOF
)"
```

### Step 7: Verify

```bash
git status
git log -1
```

## Commit Message Format

Follow the format defined in `docs/git_commit_template`:

```text
Capitalised, short description (max 50 characters)

Ticket GH-XXXXX

- Description of the commit.
- What problem is being solved and how has it been solved.
- Include any other information which might help understand the change.
```

### Structure

1. **Subject line** - Capitalised, max 50 characters, imperative mood
2. **Blank line**
3. **Ticket reference** - "Ticket GH-XXXXX" (extract from branch name)
4. **Blank line**
5. **Body** - Detailed description wrapped at 72 characters

### Subject Line Rules

- **Maximum 50 characters** - Hard limit, enforced by many tools
- **Imperative mood** - "Add feature" not "Added feature" or "Adds feature"
  - This matches commit messages generated by `git merge` and `git revert`
- **No trailing period** - It's a title, not a sentence
- **Capitalise first word** - Standard title case

### Body Rules

- **Wrap at 72 characters** - For readable git log output
- **Explain why, not what** - The diff shows what; explain the reasoning
- **Bullet points are okay** - Use hyphen followed by single space
- **Use hanging indent** - For wrapped bullet point lines
- **Separate paragraphs with blank lines**

### Reference

See `docs/git_commit_template` for the canonical format and
[A Note About Git Commit Messages](http://tbaggery.com/2008/04/19/a-note-about-git-commit-messages.html)
for background.

## What to Include

Focus on:

- **Why** the change was made
- **Business value** or technical necessity
- **Context** that isn't obvious from the code
- **Implications** or side effects
- **Related tickets** (referenced in branch name)

## What NOT to Include

**Never include information obvious from the commit or tools:**

- Coverage percentages or metrics ("Coverage increased from 90% to 91%")
- Test assertion counts ("Added 50 assertions")
- Line counts or statistics ("10 files changed, 200 insertions")
- Specific line numbers ("Fixed line 42", "Add tests for lines 191-197")
- Implementation details visible in the diff ("Changed if to unless")
- "Before and after" metrics ("Was 80%, now 95%")

**Why:** These details:

- Clutter git history with noise
- Become outdated as code evolves
- Can be regenerated by running tools
- Are visible in the diff itself

## Commit Granularity

**Prefer multiple small commits over one large commit.**

### When to Split

If you find you want to add two or more points to the subject line, that
indicates the commit should be split, or you need a higher-level summary with
details in the body.

### The "Little Story" Principle

Reading through the commit summaries in a branch should tell a little story
of how the feature was created or the bug was fixed. Each commit is a chapter
that makes sense on its own.

## Examples

### Good Commit Messages

```text
Add API endpoint routing tests

Ticket GH-1462

- Add tests for API endpoint routing in Request.pm.
- Tests verify that /iapi/v{N}/settings paths are correctly routed
  to the API class.
```

```text
Fix race condition in worker pool

Ticket GH-1523

- Workers were occasionally processing the same job twice when the
  queue was under heavy load.
- Add mutex lock around job acquisition to ensure atomic dequeue
  operations.
```

```text
Refactor authentication middleware

Ticket GH-1501

- Extract token validation into separate module to enable reuse
  across API and webhook endpoints.
- No functional changes.
```

### Bad Commit Messages

```text
Add API tests for lines 191-197

Add tests for API endpoint routing in Request.pm (lines 191-197).
Coverage increased from 90.6% to 91.5%.
Added 80 lines and 15 assertions.
```

Problems: References line numbers, includes coverage metrics, counts lines,
missing ticket reference.

```text
Fixed bug
```

Problems: Not imperative ("Fix" not "Fixed"), no context, too vague,
missing ticket reference.

```text
Updated the code to make it work better and also fixed some issues
that were causing problems in production and added some new features
that users requested.
```

Problems: Too long, vague, run-on sentence, no specific information,
missing ticket reference.

## Technical Requirements

### Use HEREDOC for Multi-line Messages

Always use HEREDOC to ensure proper formatting:

```bash
git commit -m "$(cat <<'EOF'
Subject line here

Ticket GH-XXXXX

- Body paragraph here. This ensures proper newlines
  and special characters are handled correctly.
EOF
)"
```

### Never Use Interactive Flags

These flags require interactive input which is not supported:

- `git rebase -i` (interactive rebase)
- `git add -i` (interactive staging)
- `git add -p` (patch mode)

### Amend Rules

**Avoid `git commit --amend`** unless ALL conditions are met:

1. User explicitly requested amend, OR commit succeeded but pre-commit hook
   auto-modified files that need including
2. HEAD commit was created by you in this conversation
3. Commit has NOT been pushed to remote

**If commit failed or was rejected by hook:** Fix the issue and create a NEW
commit. Never amend a failed commit.

## Git Safety Protocol

- **Never** update git config
- **Never** run destructive commands (push --force, hard reset) unless
  explicitly requested
- **Never** skip hooks (--no-verify) unless explicitly requested
- **Never** force push to main/master - warn if requested

## Branch Name Reference

The branch name often contains the ticket ID. Extract it for reference:

```bash
# Get current branch
git branch --show-current

# Example: GH-1462-feature-name -> Ticket is GH-1462
```

## Empty Commits

If there are no changes to commit (no untracked files and no modifications),
do not create an empty commit. Inform the user that there's nothing to commit.

## Post-Commit

After a successful commit:

1. Show the commit hash and message
2. Run `git status` to confirm clean state
3. Note if the branch is ahead of remote (needs push)

Do NOT push unless the user explicitly asks.
